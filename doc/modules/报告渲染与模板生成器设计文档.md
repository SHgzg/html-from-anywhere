# 报告渲染与模板生成器设计文档

## 1. 设计目标

本模块用于定义 **报告从结构化数据到最终展示内容的生成机制**。

设计目标是：

* 将“数据结果”与“展示形式”彻底解耦
* 支持多种渲染模式（Render Mode）
* 保证渲染阶段可预测、可替换、可扩展

渲染模块不参与数据获取，也不参与 Action 调度。

---

## 2. Render Phase 的系统定位

Render Phase 位于：

```
Data Phase
  ↓
Render Phase
  ↓
Action Phase
```

其存在是 **条件性的**：

* 仅当存在 Action 依赖 report_ready 事件时才执行

Render Phase 的输入与输出是明确、有限的。

---

## 3. Render Mode 定义

Render Mode 用于描述“以何种形式生成报告内容”。

系统内置以下 Render Mode：

### 3.1 HTML Report Mode

特征：

* 生成完整 HTML 文档
* 允许内嵌或引用 JavaScript
* 支持交互行为

适用场景：

* 存储到对象存储（MinIO）
* 提供访问链接
* 长期归档

---

### 3.2 Email Report Mode

特征：

* 生成邮件友好内容
* 偏向 inline 样式
* 避免复杂脚本

适用场景：

* 邮件正文
* 邮件附件（HTML / text）

---

## 4. 模板生成器（Template Generator）

### 4.1 职责定义

Template Generator 是 Render Phase 的执行单元，其职责是：

> 将 DataResult + ExecutableConfig 转换为某种 Render Mode 的最终内容

它不关心：

* 数据来源
* Action 行为

---

### 4.2 输入契约

每个 Template Generator 接收：

* dataResults

  * 标准化后的数据集合

* executableConfig

  * 已完成 Enhance 的最终配置

* runtimeContext（只读）

  * 包含 dateContext 等运行时信息

---

### 4.3 输出契约（RenderResult）

Template Generator 必须返回一个 RenderResult：

* renderMode
* content

  * HTML / text / 结构化内容
* meta

  * 可选元信息（如标题、摘要、资源依赖）

RenderResult 是 Action 的唯一渲染依赖。

---

## 5. Render Orchestrator

### 5.1 职责

Render Orchestrator 负责：

* 分析所有 Action 对 renderMode 的需求
* 决定需要执行哪些 Template Generator
* 保证每种 renderMode 只生成一次

---

### 5.2 执行规则

* 若无 Action 依赖 report_ready：

  * Render Phase 被跳过

* 若存在多个 Action 依赖同一 renderMode：

  * 共享同一个 RenderResult

---

## 6. Action 与 RenderResult 的关系

### 6.1 data_ready Action

* 不可访问 RenderResult
* 仅可使用 DataResult

---

### 6.2 report_ready Action

* 必须声明所需 renderMode
* 只能访问对应的 RenderResult

---

## 7. Render 错误处理策略

* 单一 Render Mode 失败：

  * 不影响其他 Render Mode
  * 仅影响依赖该模式的 Action

* Render Generator 内部错误：

  * 视为渲染错误
  * 不回退至其他模式

---

## 8. 扩展性原则

### 8.1 新 Render Mode

新增 Render Mode 时，需满足：

* 有明确使用场景
* 不破坏现有生命周期
* 不引入跨阶段依赖

---

### 8.2 模板技术选型约束

模板技术应满足：

* 纯函数渲染
* 无副作用
* 不直接执行外部 IO

模板引擎本身不在本设计文档范围内。

---

## 9. 本模块边界声明

本模块 **不负责**：

* Action 执行
* 存储策略
* 邮件发送
* Enhance 逻辑

它只负责：

> 定义“如何把数据变成可消费的报告内容”

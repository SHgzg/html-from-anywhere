# 基础配置与启动模块设计文档

## 1. 设计目标

本模块负责 **程序从“不可执行状态”进入“可确定运行状态”** 的全部过程。

其核心目标是：

* 在不解析任何报告业务逻辑之前
* 完整、确定、不可变地构建运行时上下文（RuntimeContext）
* 一旦失败，立即退出（Fail-Fast）

该模块是整个系统的 **硬前置依赖**。

---

## 2. 配置分层总览

系统中的配置被严格分为四个层级，职责互不重叠：

```
.env
  ↓
report_config.env_collection
  ↓
user_config（DB | local file）
  ↓
CLI 参数（覆盖层）
```

> 上层配置永远不能反向影响下层配置。

---

## 3. .env 配置层

### 3.1 职责定义（冻结）

`.env` 的职责 **永远不扩展**，只做一件事：

> 提供 report_config MongoDB 的连接信息

### 3.2 允许的内容

* MongoDB Host
* MongoDB Port
* Database Name
* Auth 信息（如 user / password / uri）

### 3.3 明确禁止的内容

* 运行环境（dev / prod）
* 日志级别
* 默认 MinIO
* 任何业务相关参数

> `.env` 是唯一的硬编码配置来源，也是唯一无法被覆盖的配置层。

---

## 4. report_config 数据库

### 4.1 定位

`report_config` 是 **配置的配置（Meta Configuration）数据库**。

它本身不包含任何报告逻辑，只描述：

* 系统如何运行
* 系统可以连接哪些外部资源

---

### 4.2 env collection

#### 4.2.1 加载时机

* 程序启动后 **立即加载**
* 在解析任何 user_config 之前完成

#### 4.2.2 加载策略

* **一次性完整加载**
* 不支持懒加载
* 加载失败 → 立即退出

#### 4.2.3 包含内容（逻辑分类）

1. 用户配置数据库位置

   * MongoDB 实例 / collection 信息

2. MinIO 连接配置

   * 支持多个 MinIO 实例
   * 每个实例具有唯一逻辑名称
   * 包含完整连接信息（endpoint / accessKey / secretKey / region 等）

#### 4.2.4 使用原则

* env collection 加载完成后，转换为 **RuntimeContext 的一部分**
* 后续模块不得再直接访问 report_config 数据库

---

## 5. user_config 解析入口

### 5.1 配置来源互斥规则

user_config 只能来自以下两种方式之一：

* MongoDB（通过 `--report_id`）
* 本地文件（通过 `--config_path`）

二者 **完全互斥**。

```
(report_id XOR config_path) === true
```

---

### 5.2 MongoDB 模式（--report_id）

执行流程：

1. 从 CLI 读取 `report_id`
2. 使用 env collection 中定义的 user_config 数据库位置
3. 从 user_config collection 中读取对应配置

失败策略：

* report_id 不存在 → 报错退出

---

### 5.3 本地文件模式（--config_path）

执行流程：

1. 从 CLI 读取 `config_path`
2. 加载并解析本地 JSON 文件
3. 作为 **唯一 user_config 来源**

限制：

* 不访问 user_config collection
* 不要求 report_id

失败策略：

* 文件不存在 / JSON 解析失败 → 报错退出

---

## 6. CLI 参数层

### 6.0 参数互斥与校验规则

CLI 在解析阶段必须执行以下强约束校验：

* `--report_id` 与 `--config_path` **严格互斥**
* 两者必须且只能存在一个

非法示例：

* 同时提供 `--report_id` 与 `--config_path`
* 两者均未提供

校验失败时：

* 不进入任何配置或业务阶段
* 直接报错并退出

---

### 6.1 CLI 的定位

CLI 参数是 **最高优先级的配置覆盖层**。

其职责是：

* 注入运行时变量
* 覆盖 user_config 中的部分字段

### 6.2 当前支持的参数

* `--report_id`
* `--config_path`
* `--date=YYYY-MM-DD`

### 6.3 设计原则

* CLI 参数永远不直接参与 Enhance
* CLI 只影响最终可执行配置

---

## 7. RuntimeContext 构建

### 7.0 模板占位符与日期上下文（新增）

在 user_config 被成功解析后、进入任何 Enhance 或数据阶段之前，系统必须执行一次 **模板占位符替换（Template Resolution）**。

该步骤是 user_config 进入“可执行状态”的第一步。

---

### 7.1 --date 参数与默认规则

* CLI 允许传入：

  * `--date=YYYY-MM-DD`
* 当未提供时：

  * 默认使用 **程序启动当天（本地时间）**

该 date 将被解析为一个 **DateContext**，作为后续模板替换的唯一时间来源。

---

### 7.2 内置日期占位符规范

在 user_config 的任意字符串字段中，允许使用以下占位符：

| 占位符         | 含义     | 示例（2025-01-01） |
| ----------- | ------ | -------------- |
| ${YYYY}     | 四位年份   | 2025           |
| ${YY}       | 两位年份   | 25             |
| ${MM}       | 月（补零）  | 01             |
| ${DD}       | 日（补零）  | 01             |
| ${YYYYMMDD} | 年月日    | 20250101       |
| ${YYMMDD}   | 两位年+月日 | 250101         |
| ${MMDD}     | 月日     | 0101           |

> 所有占位符均为 **纯字符串替换**，不涉及表达式计算。

---

### 7.3 替换范围与时机

模板替换的作用范围：

* user_config 中的 **所有字符串字段**

  * 包括但不限于：

    * source
    * path
    * title
    * action.spec 中的字符串

替换时机：

```
Resolve user_config
  ↓
Apply Template Resolution   ← 必须先于 Enhance
  ↓
Apply Enhance (if allowed)
```

---

### 7.4 错误与兜底策略

* 未识别的占位符：

  * 保留原样，不报错
* 缺失 date 上下文：

  * 不允许（date 永远存在，来自 CLI 或默认值）

---

### 7.5 扩展性原则

* 日期占位符是 **内置系统能力**
* 未来可扩展：

  * ${HH} / ${mm} / ${ss}
  * ${ISO_DATE}
  * ${TIMESTAMP}

但扩展必须遵循：

* 不引入表达式语法
* 不引入条件逻辑
* 不允许用户自定义函数

---

### 7.6 RuntimeContext 中的 DateContext

RuntimeContext 必须显式包含：

* dateContext

  * rawDate（YYYY-MM-DD）
  * derivedFields（YYYY / YY / MM / DD / ...）

该对象在启动阶段构建完成，后续只读。

---

### 7.1 定义

RuntimeContext 是程序运行期间的 **唯一可信上下文对象**。

它在 Bootstrap 阶段构建完成，此后只读。

### 7.2 包含内容（逻辑结构）

* envConfig

  * MinIO 映射表
  * user_config DB 定位信息

* userConfig

  * 原始用户配置（DB 或 local）

* cliArgs

  * 解析后的 CLI 参数

---

## 8. 启动流程总览

```
Start
  ↓
Load .env
  ↓
Connect report_config DB
  ↓
Load env collection
  ↓
Resolve user_config (DB | local)
  ↓
Parse CLI args
  ↓
Build RuntimeContext
  ↓
Enter Config Phase
```

任何一步失败，程序立即终止。

---

## 9. 错误模型（Fail-Fast）

以下错误均视为 **致命错误**：

* .env 缺失或非法
* report_config 无法连接
* env collection 加载失败
* user_config 无法解析
* CLI 参数互斥规则冲突

这些错误：

* 不进入任何业务阶段
* 不执行任何 action

---

## 10. 本模块边界声明

本模块 **不负责**：

* Enhance
* 数据加载
* 报告生成
* Action 执行

它只负责：

> 为后续所有模块提供一个“确定、完整、不可变”的运行基础

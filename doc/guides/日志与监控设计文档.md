# 日志与监控设计文档

## 1. 设计目标

本文档用于定义 **Report CLI 的日志输出和监控策略**。

目标是：
- 提供清晰、结构化的日志输出
- 支持不同场景的日志级别
- 关键节点的监控和埋点
- 便于调试和问题排查

---

## 2. 日志级别定义

### 2.1 级别划分

| 级别 | 值 | 用途 | 输出条件 |
|------|-----|------|----------|
| **trace** | 10 | 最详细的调试信息 | 需要深入追踪 |
| **debug** | 20 | 调试信息 | 开发调试 |
| **info** | 30 | 一般信息 | 关键操作、阶段切换 |
| **warn** | 40 | 警告信息 | 非致命错误、降级处理 |
| **error** | 50 | 错误信息 | 阶段失败、执行错误 |
| **fatal** | 60 | 致命错误 | 无法继续执行 |

### 2.2 默认级别

- **开发模式**: `debug`
- **生产模式**: `info`
- **静默模式**: `error` + `fatal`

### 2.3 级别控制

```bash
# 通过 CLI 参数
report-cli --log-level debug

# 通过环境变量
export REPORT_CLI_LOG_LEVEL=debug

# 通过配置文件
{
  "logLevel": "debug"
}
```

---

## 3. 日志格式规范

### 3.1 文本格式（默认）

```
[LEVEL] YYYY-MM-DD HH:mm:ss.SSS - <模块名> - <消息>
    <上下文信息>
```

**示例：**
```
[INFO] 2025-01-30 10:30:00.123 - bootstrap - Starting Bootstrap Phase
[DEBUG] 2025-01-30 10:30:00.456 - bootstrap - Loading .env from /path/to/.env
[INFO] 2025-01-30 10:30:01.789 - bootstrap - Connected to MongoDB
    host: localhost
    port: 27017
    database: report_config
[INFO] 2025-01-30 10:30:02.012 - bootstrap - Bootstrap complete (1.2s)
```

### 3.2 JSON 格式

```json
{
  "level": "info",
  "timestamp": "2025-01-30T10:30:00.123Z",
  "module": "bootstrap",
  "message": "Starting Bootstrap Phase",
  "context": {
    "phase": "bootstrap",
    "step": "start"
  },
  "duration": null
}
```

### 3.3 结构化字段

| 字段 | 类型 | 说明 |
|------|------|------|
| level | string | 日志级别 |
| timestamp | string | ISO 8601 时间戳 |
| module | string | 模块名称 |
| message | string | 日志消息 |
| context | object | 上下文信息 |
| duration | number\|null | 耗时（毫秒） |
| error | object\|null | 错误信息（如有） |

---

## 4. 关键埋点

### 4.1 Bootstrap Phase

```typescript
logger.info('bootstrap', 'Starting Bootstrap Phase');

logger.debug('bootstrap', 'Loading .env file', {
  path: envPath
});

logger.info('bootstrap', 'Connecting to MongoDB', {
  host: config.host,
  port: config.port,
  database: config.database
});

logger.info('bootstrap', 'Loading env collection', {
  collection: 'env_collection'
});

logger.info('bootstrap', 'Bootstrap complete', {
  duration: 1234
});
```

### 4.2 Config Phase

```typescript
logger.info('config', 'Starting Config Phase');

logger.debug('config', 'Loading user_config', {
  source: 'db' | 'local',
  reportId?: string,
  configPath?: string
});

logger.debug('config', 'Applying template resolution', {
  dateContext: runtime.dateContext
});

logger.debug('config', 'Checking deprecated status', {
  deprecated: config.deprecated?.status
});

logger.debug('config', 'Applying enhances', {
  count: enhanceCount
});

logger.info('config', 'Config complete', {
  dataItemCount: config.data.length,
  actionCount: config.actions.length,
  duration: 567
});
```

### 4.3 Data Phase

```typescript
logger.info('data', 'Starting Data Phase', {
  dataItemCount: config.data.length
});

for (const item of config.data) {
  logger.debug('data', `Fetching data: ${item.title}`, {
    sourceType: detectSourceType(item.source),
    source: item.source
  });

  try {
    const result = await fetchData(item);
    logger.info('data', `Data fetched: ${item.title}`, {
      rowCount: result.data?.length || 0,
      duration: result.elapsed
    });
  } catch (error) {
    logger.error('data', `Data fetch failed: ${item.title}`, {
      error: error.message,
      duration: result.elapsed
    });
    throw error;
  }
}

logger.info('data', 'Emitting event: data_ready');

logger.info('data', 'Data complete', {
  successCount: successCount,
  failCount: failCount,
  duration: 3456
});
```

### 4.4 Render Phase

```typescript
logger.info('render', 'Starting Render Phase', {
  renderModes: ['html', 'email']
});

for (const mode of renderModes) {
  logger.debug('render', `Generating report: ${mode}`, {
    dataCount: dataResults.length
  });

  const result = await render(mode, dataResults);
  logger.info('render', `Report generated: ${mode}`, {
    contentLength: result.content.length,
    duration: result.elapsed
  });

  logger.info('render', `Emitting event: report_ready`, {
    renderMode: mode
  });
}

logger.info('render', 'Render complete', {
  modeCount: renderModes.length,
  duration: 2100
});
```

### 4.5 Action Phase

```typescript
logger.info('action', `Starting Action Phase: ${event}`, {
  actionCount: actions.length
});

for (const action of actions) {
  logger.debug('action', `Executing action: ${action.type}`, {
    on: action.on,
    spec: redactSensitive(action.spec)
  });

  try {
    await executeAction(action);
    logger.info('action', `Action executed: ${action.type}`, {
      duration: action.elapsed
    });
  } catch (error) {
    logger.error('action', `Action failed: ${action.type}`, {
      error: error.message,
      stack: error.stack
    });
    // 不中断其他 action
  }
}

logger.info('action', 'Action complete', {
  successCount: successCount,
  failCount: failCount,
  duration: 5600
});
```

---

## 5. 敏感信息处理

### 5.1 需要脱敏的字段

```typescript
const SENSITIVE_FIELDS = [
  'password',
  'secret',
  'token',
  'apiKey',
  'accessKey',
  'secretKey',
  'authorization',
  'cookie'
];

function redactSensitive(obj: unknown): unknown {
  // 递归脱敏敏感字段
  // 替换为 '***REDACTED***'
}
```

### 5.2 脱敏示例

```json
// 原始日志
{
  "spec": {
    "to": "user@example.com",
    "password": "mySecretPassword"
  }
}

// 脱敏后日志
{
  "spec": {
    "to": "user@example.com",
    "password": "***REDACTED***"
  }
}
```

---

## 6. 性能监控

### 6.1 阶段耗时统计

每个 Phase 必须记录：

```typescript
interface PhaseMetrics {
  phase: string;
  startTime: number;
  endTime: number;
  duration: number;
  success: boolean;
  error?: Error;
  metadata?: Record<string, unknown>;
}
```

### 6.2 数据源耗时统计

每个数据源请求必须记录：

```typescript
interface DataSourceMetrics {
  title: string;
  sourceType: string;
  startTime: number;
  endTime: number;
  duration: number;
  success: boolean;
  rowCount?: number;
  error?: Error;
}
```

### 6.3 性能日志输出

```
[INFO] 2025-01-30 10:30:15.123 - metrics - Phase Performance Summary
Bootstrap Phase:  1.2s  ✓
Config Phase:     0.5s  ✓
Data Phase:       3.4s  ✓
  - 用户数据:      2.3s  ✓ (100 rows)
  - 订单数据:      1.1s  ✓ (500 rows)
  - 产品数据:      0.0s  ✓ (cached)
Render Phase:     2.1s  ✓
Action Phase:     5.6s  ✓
  - Email:         3.2s  ✓
  - Storage:       2.4s  ✓
Total:            12.8s
```

---

## 7. 错误监控

### 7.1 错误分类

```typescript
enum ErrorCategory {
  CONFIG_ERROR = 'config_error',
  DATA_SOURCE_ERROR = 'data_source_error',
  RENDER_ERROR = 'render_error',
  ACTION_ERROR = 'action_error',
  SYSTEM_ERROR = 'system_error'
}

interface ErrorLog {
  category: ErrorCategory;
  code: string;
  message: string;
  stack?: string;
  context: Record<string, unknown>;
  timestamp: string;
}
```

### 7.2 错误日志示例

```json
{
  "level": "error",
  "timestamp": "2025-01-30T10:30:05.123Z",
  "module": "data",
  "message": "Data source fetch failed",
  "error": {
    "category": "data_source_error",
    "code": "HTTP_TIMEOUT",
    "message": "Request timeout after 30000ms",
    "stack": "Error: Request timeout\n    at DataSourceAdapter.fetch...",
    "context": {
      "sourceType": "http",
      "url": "https://api.example.com/users",
      "timeout": 30000
    }
  }
}
```

---

## 8. 执行摘要

### 8.1 成功摘要

```typescript
interface ExecutionSummary {
  status: 'success';
  reportId: string;
  date: string;
  startTime: string;
  endTime: string;
  duration: number;
  phases: PhaseSummary[];
  dataSources: DataSourceSummary[];
  actions: ActionSummary[];
}
```

**输出示例：**
```
========================================
Report CLI 执行摘要
========================================

报告ID: daily_report
日期: 2025-01-30
开始时间: 2025-01-30 10:30:00
结束时间: 2025-01-30 10:30:13
总耗时: 12.8s

阶段执行:
  ✓ Bootstrap    1.2s
  ✓ Config       0.5s
  ✓ Data         3.4s
  ✓ Render       2.1s
  ✓ Action       5.6s

数据源: 3 个
  ✓ 用户数据      2.3s  100 rows
  ✓ 订单数据      1.1s  500 rows
  ✓ 产品数据      0.0s  50 rows  [cached]

渲染: 2 个模式
  ✓ HTML         2.1s  45KB
  ✓ Email        1.8s  12KB

Action: 2 个
  ✓ Email        3.2s  sent to: user@example.com
  ✓ Storage      2.4s  uploaded to: MinIO

状态: 成功 ✓
```

### 8.2 失败摘要

```
========================================
Report CLI 执行摘要
========================================

报告ID: daily_report
日期: 2025-01-30
开始时间: 2025-01-30 10:30:00
结束时间: 2025-01-30 10:30:05
总耗时: 4.6s

阶段执行:
  ✓ Bootstrap    1.2s
  ✓ Config       0.5s
  ✗ Data         2.9s
  - Render       (skipped)
  - Action       (skipped)

错误:
  ✗ 数据源失败: "用户数据"
    类型: HTTP_TIMEOUT
    消息: Request timeout after 30000ms
    URL: https://api.example.com/users

状态: 失败 ✗
退出码: 4
```

---

## 9. 日志配置

### 9.1 配置选项

```typescript
interface LogConfig {
  level: 'trace' | 'debug' | 'info' | 'warn' | 'error' | 'fatal';
  format: 'text' | 'json';
  output: 'console' | 'file' | 'both';
  file?: {
    path: string;
    maxSize: string;  // e.g., '10M'
    maxFiles: number;
  };
  colorize: boolean;
  timestamp: boolean;
  prettyPrint: boolean;
}
```

### 9.2 默认配置

```typescript
const defaultLogConfig: LogConfig = {
  level: 'info',
  format: 'text',
  output: 'console',
  colorize: true,
  timestamp: true,
  prettyPrint: false
};
```

---

## 10. 日志库选择建议

### 10.1 推荐库

| 库 | 优点 | 缺点 | 推荐场景 |
|------|------|------|----------|
| **pino** | 高性能、结构化 | 需要插件支持 pretty print | 生产环境 |
| **winston** | 功能丰富、社区大 | 性能略低 | 开发环境 |
| **bunyan** | 成熟稳定 | 配置较复杂 | 大型项目 |

### 10.2 推荐配置（Pino）

```typescript
import pino from 'pino';

const logger = pino({
  level: config.logLevel,
  formatters: {
    level: (label) => {
      return { level: label };
    }
  },
  timestamp: pino.stdTimeFunctions.isoTime,
  serializers: {
    error: pino.stdSerializers.err,
    req: pino.stdSerializers.req
  },
  redact: ['password', 'secret', 'token']
});

// 开发环境添加 pretty print
if (process.env.NODE_ENV !== 'production') {
  const pretty = pino.pretty();
  pretty.pipe(process.stdout);
  logger = pino({}, pretty);
}
```

---

## 11. 调试支持

### 11.1 Debug 模式

```bash
# 启用 debug 级别
report-cli --log-level debug

# 输出示例
[DEBUG] 2025-01-30 10:30:00.123 - bootstrap - Parsing CLI args
[DEBUG] 2025-01-30 10:30:00.124 - bootstrap - CLI args: { reportId: 'daily_report' }
[DEBUG] 2025-01-30 10:30:00.125 - bootstrap - Loading .env from /path/to/.env
[DEBUG] 2025-01-30 10:30:00.126 - bootstrap - .env loaded: { MONGO_URI: '***' }
[INFO] 2025-01-30 10:30:00.127 - bootstrap - Starting Bootstrap Phase
```

### 11.2 Trace 模式

```bash
# 启用 trace 级别（最详细）
report-cli --log-level trace

# 包含：
# - 函数调用栈
# - 变量值
# - 中间状态
# - 性能细节
```

---

## 12. 监控指标

### 12.1 关键指标

| 指标 | 说明 | 告警阈值 |
|------|------|----------|
| 总执行时间 | 完整流程耗时 | > 60s |
| Phase 耗时 | 单个阶段耗时 | > 30s |
| 数据源耗时 | 单个数据源耗时 | > 15s |
| Action 耗时 | 单个 action 耗时 | > 30s |
| 失败率 | 执行失败比例 | > 5% |

### 12.2 指标收集

```typescript
interface Metrics {
  startTime: number;
  endTime: number;
  duration: number;
  phases: Record<string, number>;
  dataSources: Record<string, number>;
  actions: Record<string, number>;
  errors: ErrorLog[];
}

function collectMetrics(): Metrics {
  // 收集并返回指标
}
```

---

## 13. 本文档边界声明

本文档 **不负责**：
- 具体的日志库实现细节
- 日志的持久化存储方案
- 监控系统的搭建

它只负责：
> **定义日志的级别、格式、关键埋点和输出规范**
